<template>
  <div class="min-h-screen">
    <!-- Header -->
    <SimpleHeader />
    
    <div class="container mx-auto px-6 py-8">
      <div v-if="pending" class="flex justify-center items-center min-h-96">
        <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500"></div>
      </div>

      <div v-else-if="error" class="text-center py-16">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Êõ∏Á±ç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</h2>
        <p class="text-gray-600 dark:text-gray-300 mb-8">ÊåáÂÆö„Åï„Çå„ÅüÊõ∏Á±ç„ÅØÂ≠òÂú®„Åó„Å™„ÅÑ„Åã„ÄÅÂâäÈô§„Åï„Çå„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ</p>
        <button 
          @click="goHome"
          class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 hover:scale-105"
        >
          „Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´Êàª„Çã
        </button>
      </div>

      <div v-else-if="book" class="max-w-4xl mx-auto">
        <!-- „Éë„É≥„Åè„Åö„Éä„Éì -->
        <nav class="mb-6 text-sm">
          <ol class="flex space-x-2 text-gray-500 dark:text-gray-400">
            <li><NuxtLink to="/" class="hover:text-blue-600 dark:hover:text-blue-400">„Éõ„Éº„É†</NuxtLink></li>
            <li>‚Ä∫</li>
            <li class="text-gray-800 dark:text-gray-200">{{ book.title }}</li>
          </ol>
        </nav>

        <!-- Êõ∏Á±ç„É°„Ç§„É≥ÊÉÖÂ†± -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden mb-6 transition-all duration-300">
          <div class="p-6 lg:p-8">
            <!-- „É¢„Éê„Ç§„É´ÂÑ™ÂÖàÔºöÁ∏¶Á©ç„Åø„É¨„Ç§„Ç¢„Ç¶„Éà -->
            <div class="space-y-6">
              <!-- ‰∏äÈÉ®ÔºöÊõ∏Á±çÂü∫Êú¨ÊÉÖÂ†± -->
              <div class="flex flex-col sm:flex-row gap-6">
                <!-- Êõ∏ÂΩ± -->
                <div class="flex-shrink-0 mx-auto sm:mx-0">
                  <div class="w-32 h-44 sm:w-40 sm:h-56 bg-gray-100 dark:bg-gray-700 rounded-xl shadow-sm overflow-hidden">
                    <div v-if="book.imageUrl" class="w-full h-full">
                      <img 
                        :src="book.imageUrl" 
                        :alt="book.title"
                        class="w-full h-full object-cover"
                      >
                    </div>
                    <div v-else class="w-full h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-500">
                      <Icon name="heroicons:book-open" class="w-8 h-8 mb-2" />
                      <p class="text-xs">Êõ∏ÂΩ±„Å™„Åó</p>
                    </div>
                  </div>
                </div>

                <!-- „Çø„Ç§„Éà„É´„ÉªËëóËÄÖ„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥ -->
                <div class="flex-grow text-center sm:text-left">
                  <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-3 leading-tight">
                    {{ book.title }}
                  </h1>
                  <p class="text-lg text-gray-600 dark:text-gray-300 mb-4">
                    {{ Array.isArray(book.author) ? book.author.join(', ') : book.author }}
                  </p>
                  
                  <!-- „Ç´„ÉÜ„Ç¥„É™„Éê„ÉÉ„Ç∏„Å®„ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥ -->
                  <div class="flex justify-center sm:justify-start items-center gap-3 mb-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300">
                      {{ Array.isArray(book.category) ? book.category[0] : book.category }}
                    </span>
                    
                    <!-- „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥ -->
                    <button
                      name="toggle-favorite"
                      @click="toggleFavorite"
                      class="w-8 h-8 rounded-full flex items-center justify-center hover:scale-110 active:scale-95 focus:outline-none transition-transform duration-200 ease-out"
                      :aria-label="isFavorite ? '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Åã„ÇâÂâäÈô§' : '„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†'"
                    >
                      <span class="relative w-5 h-5">
                        <Icon
                          name="heroicons:heart-solid"
                          :class="[
                            'w-5 h-5 favorite-heart-icon',
                            isFavorite
                              ? 'text-red-500 fill-red-500 heart-filled'
                              : 'text-gray-300 fill-gray-300 heart-empty'
                          ]"
                        />
                      </span>
                    </button>
                  </div>
                  
                  <!-- „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                  <div class="flex flex-col sm:flex-row gap-3 justify-center sm:justify-start items-center">
                    <a 
                      v-if="book.amazonUrl"
                      :href="book.amazonUrl"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-semibold hover:from-orange-600 hover:to-orange-700 transition-all duration-200 shadow-md hover:shadow-lg"
                    >
                      <Icon name="heroicons:shopping-cart" class="w-5 h-5" />
                      Amazon „ÅßË≥ºÂÖ•
                    </a>
                  </div>
                </div>
              </div>

              <!-- „É°„Ç§„É≥„Çπ„Ç≥„Ç¢„Çª„ÇØ„Ç∑„Éß„É≥ -->
              <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-blue-900/20 dark:via-indigo-900/20 dark:to-purple-900/20 rounded-2xl p-6 border border-blue-100 dark:border-blue-800/50">
                <div class="flex flex-col lg:flex-row items-center gap-6">
                  <!-- Â∑¶ÂÅ¥Ôºö„Çπ„Ç≥„Ç¢Ë¶ñË¶öÂåñ -->
                  <div class="flex-shrink-0">
                    <div class="relative w-32 h-32 sm:w-40 sm:h-40">
                      <!-- ËÉåÊôØÂÜÜ -->
                      <svg class="w-full h-full transform -rotate-90" viewBox="0 0 160 160">
                        <circle
                          cx="80"
                          cy="80"
                          r="70"
                          stroke="currentColor"
                          :stroke-width="8"
                          fill="none"
                          class="text-gray-200 dark:text-gray-700"
                        />
                        <!-- „Çπ„Ç≥„Ç¢ÂÜÜ -->
                        <circle
                          cx="80"
                          cy="80"
                          r="70"
                          stroke="currentColor"
                          :stroke-width="8"
                          fill="none"
                          :class="getScoreTextClass(goodBookScore)"
                          :stroke-dasharray="circumference"
                          :stroke-dashoffset="getStrokeDashoffset(goodBookScore)"
                          stroke-linecap="round"
                          class="transition-all duration-1000 ease-out"
                        />
                      </svg>
                      <!-- ‰∏≠Â§Æ„ÅÆ„Çπ„Ç≥„Ç¢ -->
                      <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span class="text-3xl sm:text-4xl font-bold" :class="getScoreTextClass(goodBookScore)">
                          {{ goodBookScore }}
                        </span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">/ 100</span>
                        <span class="text-xs font-medium text-gray-600 dark:text-gray-300 mt-1">
                          {{ getScoreLabel(goodBookScore).replace(/üèÜ|‚≠ê|üåü|üëç|üìö|üí≠/, '').trim() }}
                        </span>
                      </div>
                    </div>
                  </div>

                  <!-- ‰∏≠Â§ÆÔºö„Çπ„Ç≥„Ç¢ÊßãÊàêË¶ÅÁ¥† -->
                  <div class="flex-grow">
                    <div class="text-center lg:text-left mb-4">
                      <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">üìä „ÅÑ„ÅÑÊú¨„Çπ„Ç≥„Ç¢</h3>
                      <p class="text-sm text-gray-600 dark:text-gray-400">Ë®ò‰∫ãÊï∞„ÉªLGTM„ÉªÊúÄÊñ∞ÊÄß„Åã„ÇâÁÆóÂá∫</p>
                    </div>
                    
                    <!-- „Çπ„Ç≥„Ç¢ÂÜÖË®≥ÔºàÂü∫Êú¨Ë°®Á§∫Ôºâ -->
                    <div class="space-y-3 mb-4">
                      <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400 flex-1">Ë®ò‰∫ãÊï∞</span>
                        <span class="text-sm font-semibold text-gray-900 dark:text-white">40%</span>
                      </div>
                      <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-purple-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400 flex-1">LGTMÊï∞</span>
                        <span class="text-sm font-semibold text-gray-900 dark:text-white">35%</span>
                      </div>
                      <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                        <span class="text-sm text-gray-600 dark:text-gray-400 flex-1">ÊúÄÊñ∞ÊÄß</span>
                        <span class="text-sm font-semibold text-gray-900 dark:text-white">25%</span>
                      </div>
                    </div>

                    <!-- Ë©≥Á¥∞Ë°®Á§∫„Éú„Çø„É≥ -->
                    <div class="flex items-center justify-between">
                      <button 
                        ref="scoreButton"
                        @click="toggleScoreDetails"
                        class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-all duration-200 flex items-center gap-1 hover:scale-105"
                      >
                        <Icon name="heroicons:information-circle" class="w-5 h-5" />
                        ÁÆóÂá∫ÊñπÊ≥ï„ÇíË¶ã„Çã
                      </button>
                    </div>

                    <!-- „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„Éù„ÉÉ„Éó„Ç™„Éº„Éê„ÉºÔºàTeleportÁâà„Éª„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºâ -->
                    <Teleport to="body">
                      <div 
                        v-if="showScoreDetails && !isMobile" 
                        class="fixed w-96 p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl backdrop-blur-sm"
                        :style="popoverStyle"
                        data-score-popover
                        @click.stop
                      >
                        <div class="space-y-4">
                          <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-white">„Çπ„Ç≥„Ç¢ÁÆóÂá∫ÊñπÊ≥ï</h4>
                            <button 
                              @click="showScoreDetails = false"
                              class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all duration-200 hover:scale-110 rounded-full p-1"
                            >
                              <Icon name="heroicons:x-mark" class="w-5 h-5" />
                            </button>
                          </div>
                          
                          <!-- „Çπ„Ç≥„Ç¢ÊßãÊàêË¶ÅÁ¥† -->
                          <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                              <div class="flex items-center gap-3">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <div>
                                  <div class="font-medium text-green-700 dark:text-green-400 text-sm">Ë®ò‰∫ãÊï∞</div>
                                  <div class="text-xs text-green-600 dark:text-green-300">{{ book.uniqueArticleCount || 0 }}‰ª∂</div>
                                </div>
                              </div>
                              <div class="flex items-center gap-2">
                                <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full">
                                  <div class="h-1.5 bg-green-500 rounded-full" style="width: 40%"></div>
                                </div>
                                <span class="text-sm font-bold text-green-600 dark:text-green-400">40%</span>
                              </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                              <div class="flex items-center gap-3">
                                <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                                <div>
                                  <div class="font-medium text-purple-700 dark:text-purple-400 text-sm">LGTMÊï∞</div>
                                  <div class="text-xs text-purple-600 dark:text-purple-300">{{ mentions.reduce((sum, m) => sum + m.articleLikes, 0) || 245 }}‰ª∂</div>
                                </div>
                              </div>
                              <div class="flex items-center gap-2">
                                <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full">
                                  <div class="h-1.5 bg-purple-500 rounded-full" style="width: 35%"></div>
                                </div>
                                <span class="text-sm font-bold text-purple-600 dark:text-purple-400">35%</span>
                              </div>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                              <div class="flex items-center gap-3">
                                <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                                <div>
                                  <div class="font-medium text-orange-700 dark:text-orange-400 text-sm">ÊúÄÊñ∞ÊÄß</div>
                                  <div class="text-xs text-orange-600 dark:text-orange-300">{{ getRecencyLabel(book.lastMentionedAt || new Date().toISOString()) }}</div>
                                </div>
                              </div>
                              <div class="flex items-center gap-2">
                                <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full">
                                  <div class="h-1.5 bg-orange-500 rounded-full" style="width: 25%"></div>
                                </div>
                                <span class="text-sm font-bold text-orange-600 dark:text-orange-400">25%</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </Teleport>

                    <!-- „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´Ôºà„É¢„Éê„Ç§„É´Ôºâ -->
                    <div 
                      v-if="showScoreDetails && isMobile" 
                      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
                      @click="showScoreDetails = false"
                    >
                        <div 
                          class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl"
                          data-score-popover
                          @click.stop
                        >
                          <div class="space-y-4">
                            <div class="flex justify-between items-center">
                              <h4 class="text-lg font-semibold text-gray-900 dark:text-white">„Çπ„Ç≥„Ç¢ÁÆóÂá∫ÊñπÊ≥ï</h4>
                              <button 
                                @click="showScoreDetails = false"
                                class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-all duration-200 hover:scale-110 rounded-full p-1"
                              >
                                <Icon name="heroicons:x-mark" class="w-6 h-6" />
                              </button>
                            </div>
                            
                            <!-- „Çπ„Ç≥„Ç¢ÊßãÊàêË¶ÅÁ¥† -->
                            <div class="space-y-3">
                              <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                <div class="flex items-center gap-3">
                                  <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                  <div>
                                    <div class="font-medium text-green-700 dark:text-green-400 text-sm">Ë®ò‰∫ãÊï∞</div>
                                    <div class="text-xs text-green-600 dark:text-green-300">{{ book.uniqueArticleCount || 0 }}‰ª∂</div>
                                  </div>
                                </div>
                                <div class="flex items-center gap-2">
                                  <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full">
                                    <div class="h-1.5 bg-green-500 rounded-full" style="width: 40%"></div>
                                  </div>
                                  <span class="text-sm font-bold text-green-600 dark:text-green-400">40%</span>
                                </div>
                              </div>
                              
                              <div class="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                <div class="flex items-center gap-3">
                                  <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                                  <div>
                                    <div class="font-medium text-purple-700 dark:text-purple-400 text-sm">LGTMÊï∞</div>
                                    <div class="text-xs text-purple-600 dark:text-purple-300">{{ mentions.reduce((sum, m) => sum + m.articleLikes, 0) || 245 }}‰ª∂</div>
                                  </div>
                                </div>
                                <div class="flex items-center gap-2">
                                  <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full">
                                    <div class="h-1.5 bg-purple-500 rounded-full" style="width: 35%"></div>
                                  </div>
                                  <span class="text-sm font-bold text-purple-600 dark:text-purple-400">35%</span>
                                </div>
                              </div>
                              
                              <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
                                <div class="flex items-center gap-3">
                                  <div class="w-3 h-3 bg-orange-500 rounded-full"></div>
                                  <div>
                                    <div class="font-medium text-orange-700 dark:text-orange-400 text-sm">ÊúÄÊñ∞ÊÄß</div>
                                    <div class="text-xs text-orange-600 dark:text-orange-300">{{ getRecencyLabel(book.lastMentionedAt || new Date().toISOString()) }}</div>
                                  </div>
                                </div>
                                <div class="flex items-center gap-2">
                                  <div class="w-12 h-1.5 bg-gray-200 dark:bg-gray-600 rounded-full">
                                    <div class="h-1.5 bg-orange-500 rounded-full" style="width: 25%"></div>
                                  </div>
                                  <span class="text-sm font-bold text-orange-600 dark:text-orange-400">25%</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                    </div>
                  </div>

                  <!-- Âè≥ÂÅ¥Ôºö„É©„É≥„Ç≠„É≥„Ç∞ÊÉÖÂ†± -->
                  <div class="flex-shrink-0 lg:w-80">
                    <div class="bg-white dark:bg-gray-800/50 rounded-xl p-5 border border-gray-200 dark:border-gray-700">
                      <div class="text-center lg:text-left mb-4">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">üèÜ „É©„É≥„Ç≠„É≥„Ç∞ÊÉÖÂ†±</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400">ÁèæÂú®„ÅÆÈ†Ü‰Ωç</p>
                      </div>
                      
                      <!-- ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞ -->
                      <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg border border-blue-100 dark:border-blue-800/50">
                          <div>
                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300">ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">ÂÖ®ÊúüÈñì„ÉªÂÖ®ÂàÜÈáé</div>
                          </div>
                          <div class="text-right">
                            <div class="text-xl font-bold text-blue-600 dark:text-blue-400">{{ overallRank }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">/ {{ overallTotal.toLocaleString() }}ÂÜä</div>
                          </div>
                        </div>

                        <!-- „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÊôÇ„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞ -->
                        <div v-if="filteredRank !== null" class="flex items-center justify-between p-3 bg-gradient-to-r from-emerald-50 to-green-50 dark:from-emerald-900/20 dark:to-green-900/20 rounded-lg border border-emerald-100 dark:border-emerald-800/50">
                          <div>
                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ filterLabel }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Êù°‰ª∂Áµû„ÇäËæº„ÅøÊôÇ</div>
                          </div>
                          <div class="text-right">
                            <div class="text-xl font-bold text-emerald-600 dark:text-emerald-400">{{ filteredRank }}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">/ {{ filteredTotal.toLocaleString() }}ÂÜä</div>
                          </div>
                        </div>

                        <!-- „Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã„ÅÆË™¨Êòé -->
                        <div v-if="filteredRank !== null" class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-lg p-2 border border-gray-200 dark:border-gray-700">
                          <Icon name="heroicons:information-circle" class="w-3 h-3 inline mr-1" />
                          „É©„É≥„Ç≠„É≥„Ç∞„Éö„Éº„Ç∏„Åã„Çâ„ÅÆÁµû„ÇäËæº„ÅøÊù°‰ª∂„ÇíÂèçÊò†
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ë©≥Á¥∞ÊåáÊ®ô -->
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Ë®ÄÂèäÊï∞ -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all duration-200 hover:-translate-y-0.5 hover:scale-105">
                  <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center">
                      <Icon name="heroicons:fire" class="w-5 h-5 text-orange-600 dark:text-orange-400" />
                    </div>
                    <div>
                      <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ book.mentionCount }}</div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">Ë®ÄÂèäÊï∞</div>
                    </div>
                  </div>
                </div>

                <!-- Ë®ò‰∫ãÊï∞ -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all duration-200 hover:-translate-y-0.5 hover:scale-105">
                  <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center">
                      <Icon name="heroicons:document-text" class="w-5 h-5 text-green-600 dark:text-green-400" />
                    </div>
                    <div>
                      <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ book.uniqueArticleCount || 0 }}</div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">Ë®ò‰∫ãÊï∞</div>
                    </div>
                  </div>
                </div>

                <!-- LGTMÊï∞ -->
                <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-100 dark:border-gray-700 hover:shadow-md transition-all duration-200 hover:-translate-y-0.5 hover:scale-105">
                  <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center">
                      <Icon name="heroicons:heart" class="w-5 h-5 text-purple-600 dark:text-purple-400" />
                    </div>
                    <div>
                      <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ mentions.reduce((sum, m) => sum + m.articleLikes, 0) || 245 }}</div>
                      <div class="text-xs text-gray-500 dark:text-gray-400">LGTM</div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>


        <!-- Êõ∏Ë™åÊÉÖÂ†±„Éª„Çø„Ç∞„Çª„ÇØ„Ç∑„Éß„É≥ -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 overflow-hidden mb-6">
          <div class="border-b border-gray-100 dark:border-gray-700">
            <nav class="flex">
              <button 
                @click="activeTab = 'details'"
                :class="activeTab === 'details' 
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400' 
                  : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
                class="px-6 py-4 text-sm font-medium transition-colors"
              >
                üìñ Ë©≥Á¥∞ÊÉÖÂ†±
              </button>
              <button 
                @click="activeTab = 'tags'"
                :class="activeTab === 'tags' 
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400' 
                  : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
                class="px-6 py-4 text-sm font-medium transition-colors"
              >
                üè∑Ô∏è „Çø„Ç∞
              </button>
              <button 
                @click="activeTab = 'publication'"
                :class="activeTab === 'publication' 
                  ? 'border-b-2 border-blue-500 text-blue-600 dark:text-blue-400' 
                  : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'"
                class="px-6 py-4 text-sm font-medium transition-colors"
              >
                üìö Âá∫ÁâàÊÉÖÂ†±
              </button>
            </nav>
          </div>
          
          <div class="p-6">
            <!-- Ë©≥Á¥∞ÊÉÖÂ†±„Çø„Éñ -->
            <div v-if="activeTab === 'details'">
              <div v-if="book.description" class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Ê¶ÇË¶Å</h3>
                <p class="text-gray-700 dark:text-gray-300 leading-relaxed">{{ book.description }}</p>
              </div>
              <div class="flex flex-wrap gap-2 mb-3">
                <span 
                  v-for="category in (Array.isArray(book.category) ? book.category : [book.category])" 
                  :key="category"
                  class="inline-block bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 text-sm px-3 py-1 rounded-full"
                >
                  {{ category }}
                </span>
              </div>
            </div>

            <!-- „Çø„Ç∞„Çø„Éñ -->
            <div v-if="activeTab === 'tags'">
              <div v-if="book.tags" class="flex flex-wrap gap-2">
                <span 
                  v-for="tag in book.tags" 
                  :key="tag"
                  class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm px-3 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-200 cursor-pointer hover:scale-105"
                >
                  #{{ tag }}
                </span>
              </div>
              <div v-else class="text-gray-500 dark:text-gray-400 text-sm">„Çø„Ç∞ÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
            </div>

            <!-- Âá∫ÁâàÊÉÖÂ†±„Çø„Éñ -->
            <div v-if="activeTab === 'publication'">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                <div v-if="book.publishedYear">
                  <span class="font-medium text-gray-600 dark:text-gray-400">Âá∫ÁâàÂπ¥:</span>
                  <span class="ml-2 text-gray-900 dark:text-white">{{ book.publishedYear }}Âπ¥</span>
                </div>
                <div v-if="book.publisher">
                  <span class="font-medium text-gray-600 dark:text-gray-400">Âá∫ÁâàÁ§æ:</span>
                  <span class="ml-2 text-gray-900 dark:text-white">{{ book.publisher }}</span>
                </div>
                <div v-if="book.isbn13 || book.isbn10">
                  <span class="font-medium text-gray-600 dark:text-gray-400">ISBN:</span>
                  <span class="ml-2 text-gray-900 dark:text-white">{{ book.isbn13 || book.isbn10 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ë®ÄÂèäË®ò‰∫ã‰∏ÄË¶ß -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden transition-colors duration-300">
          <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">„Åì„ÅÆÊõ∏Á±ç„ÅåË®ÄÂèä„Åï„Çå„Å¶„ÅÑ„ÇãË®ò‰∫ã</h2>
            <p class="text-gray-600 dark:text-gray-300 mt-2">{{ mentions.length }}‰ª∂„ÅÆË®ò‰∫ã„Åß„Åì„ÅÆÊõ∏Á±ç„ÅåÁ¥π‰ªã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</p>
          </div>

          <div class="divide-y divide-gray-200 dark:divide-gray-700">
            <div 
              v-for="mention in mentions" 
              :key="mention.id"
              class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 hover:scale-[1.02]"
            >
              <div class="flex items-start justify-between">
                <div class="flex-grow">
                  <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                    <a 
                      :href="mention.articleUrl" 
                      target="_blank"
                      rel="noopener noreferrer"
                      class="hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-200 hover:underline"
                    >
                      {{ mention.articleTitle }}
                    </a>
                  </h3>
                  <p class="text-gray-600 dark:text-gray-300 mb-3">{{ mention.context }}</p>
                  <div class="flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                    <span>{{ formatDate(mention.mentionedAt) }}</span>
                    <span class="flex items-center">
                      <Icon name="heroicons:heart" class="w-4 h-4 mr-1" />
                      {{ mention.articleLikes }}
                    </span>
                    <span v-if="mention.sentiment" class="capitalize">
                      {{ getSentimentIcon(mention.sentiment) }} {{ mention.sentiment }}
                    </span>
                  </div>
                </div>
                <div class="ml-4 flex-shrink-0">
                  <div class="text-right">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">‰ø°È†ºÂ∫¶</div>
                    <div class="text-lg font-bold text-blue-600 dark:text-blue-400">
                      {{ Math.round(mention.confidence * 100) }}%
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div v-if="mentions.length === 0" class="p-8 text-center text-gray-500 dark:text-gray-400">
            <Icon name="heroicons:document-text" class="w-16 h-16 mx-auto mb-4 opacity-50" />
            <p>„Åæ„Å†Ë®ÄÂèäË®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import type { Book, BookApiResponse, DetailedRankingApiResponse, MentionsApiResponse, RankingItem } from '~/types'
import { useFavoritesStore } from '~/stores/favorites'
const route = useRoute()
const bookId = route.params.id

// Êõ∏Á±ç„Éá„Éº„Çø„ÇíÂèñÂæó
const { data: bookResponse, pending, error } = await useFetch<BookApiResponse>(`/api/books/${bookId}`)

// URL„Éë„É©„É°„Éº„Çø„Åã„Çâ„Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã„ÇíÂèñÂæó
const filterCategory = route.query.category as string || ''
const filterPeriod = route.query.period as string || 'all'

// ÂÖ®‰Ωì„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„ÇíÂèñÂæó
const { data: overallRankingData } = await useFetch<DetailedRankingApiResponse>(`/api/rankings`, {
  query: {
    type: 'overall',
    period: 'all',
    limit: 1000
  }
})

// „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÊôÇ„ÅÆÊù°‰ª∂‰ªò„Åç„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„Çø„ÇíÂèñÂæó
const { data: filteredRankingData } = await useFetch<DetailedRankingApiResponse>(`/api/rankings`, {
  query: {
    type: 'overall',
    category: filterCategory || undefined,
    period: filterPeriod !== 'all' ? filterPeriod : undefined,
    limit: 1000
  },
  default: () => null
})

// book „Éá„Éº„Çø„ÇíÂèñÂæóÔºà„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíÂê´„ÇÄÔºâ
const book = computed((): Book | null => {
  const rawBook = bookResponse.value?.data
  if (!rawBook) return null
  
  // Âûã„Ç¢„Çµ„Éº„Ç∑„Éß„É≥„ÅßÊòéÁ§∫ÁöÑ„Å´BookÂûã„Å®„Åó„Å¶Êâ±„ÅÜÔºàunknown„ÇíÁµåÁî±„Åó„Å¶ÂÆâÂÖ®„Å´Ôºâ
  const typedBook = rawBook as Book
  
  // ‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã„Éó„É≠„Éë„ÉÜ„Ç£„Å´„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆö
  return {
    ...typedBook,
    // Map old fields to new structure for compatibility
    id: typedBook.id || parseInt(typedBook._id.slice(-8), 16)
  }
})

// „ÅäÊ∞ó„Å´ÂÖ•„Çä„Çπ„Éà„Ç¢„Çí‰ΩøÁî®
const favoritesStore = useFavoritesStore()

// „Éè„Ç§„Éâ„É¨„Éº„Ç∑„Éß„É≥ÂïèÈ°å„ÇíÂõûÈÅø„Åô„Çã„Åü„ÇÅ„ÄÅ„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„Åß„ÅÆ„Åø„ÅäÊ∞ó„Å´ÂÖ•„ÇäÁä∂ÊÖã„ÇíË°®Á§∫
const isClient = ref(false)
const isFavorite = computed(() => {
  if (!isClient.value) return false // SSRÊôÇ„ÅØÂ∏∏„Å´false
  return book.value ? favoritesStore.isFavorite(book.value.id!) : false
})

// „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„Åß„Éû„Ç¶„É≥„ÉàÂæå„Å´Áä∂ÊÖã„ÇíÊõ¥Êñ∞
onMounted(() => {
  isClient.value = true
})

// „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÂàá„ÇäÊõø„Åà
const toggleFavorite = () => {
  if (book.value) {
    favoritesStore.toggleFavorite(book.value)
    
    // Á∞°Âçò„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÂäπÊûú
    if (typeof window !== 'undefined') {
      // „Éè„Éº„Éà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„ÅÆ‰∏ÄÊôÇÁöÑ„Å™„ÇØ„É©„ÇπËøΩÂä†
      const button = document.activeElement as HTMLElement
      if (button) {
        button.classList.add('animate-pulse')
        setTimeout(() => {
          button.classList.remove('animate-pulse')
        }, 200)
      }
    }
  }
}

// „Éõ„Éº„É†„Å´Êàª„Çã
const goHome = () => {
  navigateTo('/')
}

// „ÅÑ„ÅÑÊú¨„Çπ„Ç≥„Ç¢Ôºà‰ªÆ„Éá„Éº„ÇøÔºâ
const goodBookScore = ref(83)

// „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„ÅÆË°®Á§∫Áä∂ÊÖã
const showScoreDetails = ref(false)

// „É¢„Éê„Ç§„É´Âà§ÂÆö
const isMobile = ref(false)

// „Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº„ÅÆ‰ΩçÁΩÆ„Å®„Çπ„Çø„Ç§„É´
const scoreButton = ref<HTMLElement | null>(null)
const popoverStyle = ref({})

// „Çø„Éñ„ÅÆÁä∂ÊÖã
const activeTab = ref('details')

// „É¢„ÉÉ„ÇØ„ÅÆË®ÄÂèä„Éá„Éº„ÇøÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØ API „Åã„ÇâÂèñÂæóÔºâ
// Fetch mentions data from API
const { data: mentionsResponse } = await useFetch<MentionsApiResponse>(`/api/books/${bookId}/mentions`)

const mentions = computed(() => {
  return mentionsResponse.value?.data?.map((mention) => ({
    id: mention.id,
    articleTitle: mention.title,
    articleUrl: mention.url,
    context: mention.context,
    confidence: mention.confidence,
    sentiment: mention.sentiment,
    mentionedAt: mention.publishedAt,
    articleLikes: mention.likesCount
  })) || []
})

// „É©„É≥„Ç≠„É≥„Ç∞ÊÉÖÂ†±„ÇíÊ§úÁ¥¢„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
const findRankInData = (rankingData: DetailedRankingApiResponse | null | undefined) => {
  if (!book.value || !rankingData?.data?.rankings) return null
  
  const currentBook = book.value // null „ÉÅ„Çß„ÉÉ„ÇØÂæå„Å´„É≠„Éº„Ç´„É´Â§âÊï∞„Å´‰øùÂ≠ò
  
  const rankingItem = rankingData.data.rankings.find((item: RankingItem) => {
    if (!item.book) return false
    
    const bookNumericId = currentBook.id
    const bookStringId = currentBook._id
    const rankingBookNumericId = item.book.id
    const rankingBookStringId = item.book._id
    
    return (rankingBookNumericId && rankingBookNumericId === bookNumericId) ||
           (rankingBookStringId && rankingBookStringId === bookStringId)
  })
  
  return rankingItem ? {
    rank: rankingItem.rank,
    totalBooks: rankingData.data.rankings.length
  } : null
}

// ÂÖ®‰Ωì„É©„É≥„ÇØ„ÇíÂèñÂæó
const overallRank = computed(() => {
  const result = findRankInData(overallRankingData.value)
  return result ? result.rank : '„É©„É≥„ÇØÂ§ñ'
})

const overallTotal = computed(() => {
  const result = findRankInData(overallRankingData.value)
  return result ? result.totalBooks : 0
})

// „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÊôÇ„ÅÆ„É©„É≥„ÇØ„ÇíÂèñÂæó
const filteredRank = computed(() => {
  if (!filterCategory && filterPeriod === 'all') return null
  const result = findRankInData(filteredRankingData.value)
  return result ? result.rank : '„É©„É≥„ÇØÂ§ñ'
})

const filteredTotal = computed(() => {
  if (!filterCategory && filterPeriod === 'all') return 0
  const result = findRankInData(filteredRankingData.value)
  return result ? result.totalBooks : 0
})

// Ë°®Á§∫Áî®„ÅÆ„Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„É©„Éô„É´
const filterLabel = computed(() => {
  const parts = []
  if (filterCategory) {
    // „Ç´„ÉÜ„Ç¥„É™Âêç„Çí„Éû„ÉÉ„Éî„É≥„Ç∞
    const categoryNames: Record<string, string> = {
      'programming': '„Éó„É≠„Ç∞„É©„Éü„É≥„Ç∞',
      'web-development': 'WebÈñãÁô∫', 
      'ai-machine-learning': 'AI„ÉªÊ©üÊ¢∞Â≠¶Áøí',
      'infrastructure': '„Ç§„É≥„Éï„É©',
      'mobile-development': '„É¢„Éê„Ç§„É´ÈñãÁô∫',
      'game-development': '„Ç≤„Éº„É†ÈñãÁô∫',
      'data-science': '„Éá„Éº„Çø„Çµ„Ç§„Ç®„É≥„Çπ',
      'security': '„Çª„Ç≠„É•„É™„ÉÜ„Ç£',
      'devops': 'DevOps',
      'design': '„Éá„Ç∂„Ç§„É≥'
    }
    parts.push(categoryNames[filterCategory] || filterCategory)
  }
  if (filterPeriod !== 'all') {
    const periodNames: Record<string, string> = {
      'year': 'ÈÅéÂéª1Âπ¥',
      'month': 'ÈÅéÂéª1„É∂Êúà', 
      'week': 'ÈÅéÂéª1ÈÄ±Èñì'
    }
    parts.push(periodNames[filterPeriod] || filterPeriod)
  }
  return parts.join('„Éª')
})


function getSentimentIcon(sentiment: string): string {
  switch (sentiment) {
    case 'positive': return 'üòä'
    case 'negative': return 'üòû'
    default: return 'üòê'
  }
}

function formatDate(dateString: string | number | Date | null | undefined): string {
  if (!dateString) return ''
  
  try {
    const date = new Date(dateString as string | number | Date)
    if (isNaN(date.getTime())) {
      return String(dateString)
    }
    return date.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    })
  } catch (error) {
    return String(dateString)
  }
}

// Score related functions
function getScoreTextClass(score: number): string {
  if (score >= 80) return 'text-green-600 dark:text-green-400'
  if (score >= 70) return 'text-amber-600 dark:text-amber-400'
  if (score >= 60) return 'text-orange-500 dark:text-orange-400'
  return 'text-red-500 dark:text-red-400'
}
function getScoreLabel(score: number): string {
  if (score >= 90) return 'üèÜ ÊÆøÂ†ÇÂÖ•„Çä'
  if (score >= 80) return '‚≠ê Ë∂Ö„Åä„Åô„Åô„ÇÅ'
  if (score >= 70) return 'üåü „Åä„Åô„Åô„ÇÅ'
  if (score >= 60) return 'üëç ËâØÊõ∏'
  if (score >= 40) return 'üìö ÊôÆÈÄö'
  return 'üí≠ Ë¶ÅÊ§úË®é'
}
function getRecencyLabel(dateString: string): string {
  const date = new Date(dateString)
  const now = new Date()
  const monthsAgo = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24 * 30))
  
  if (monthsAgo < 1) return '‰ªäÊúà'
  if (monthsAgo < 3) return `${monthsAgo}„É∂ÊúàÂâç`
  if (monthsAgo < 12) return `${monthsAgo}„É∂ÊúàÂâç`
  const yearsAgo = Math.floor(monthsAgo / 12)
  return `${yearsAgo}Âπ¥Ââç`
}

// „Çπ„Ç≥„Ç¢Ë©≥Á¥∞„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
function toggleScoreDetails() {
  showScoreDetails.value = !showScoreDetails.value
}

// „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú„Å®„Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº„ÅÆ‰ΩçÁΩÆË™øÊï¥
onMounted(() => {
  // „É¢„Éê„Ç§„É´Âà§ÂÆö
  const checkMobile = () => {
    isMobile.value = window.innerWidth < 768
  }
  
  // „Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº„ÅÆ‰ΩçÁΩÆË™øÊï¥
  const updatePopoverPosition = () => {
    if (showScoreDetails.value && !isMobile.value && scoreButton.value) {
      const buttonRect = scoreButton.value.getBoundingClientRect()
      const viewportHeight = window.innerHeight
      const viewportWidth = window.innerWidth
      const popoverWidth = 384 // w-96 = 24rem = 384px
      const popoverHeight = 280 // Êé®ÂÆö„ÅÆÈ´ò„Åï
      
      // „Éú„Çø„É≥„ÅÆ‰ΩçÁΩÆ„ÇíÂü∫Ê∫ñ„Å´Ë®àÁÆóÔºàposition: fixed„Å™„ÅÆ„Åßscroll„ÅØ‰∏çË¶ÅÔºâ
      let left = buttonRect.left
      let top = buttonRect.bottom + 8 // „Éú„Çø„É≥„ÅÆ‰∏ã„Å´8pxÁ©∫„Åë„Çã
      
      
      // Âè≥Á´Ø„Å´„ÅØ„ÅøÂá∫„ÇãÂ†¥Âêà„ÅØÂ∑¶ÂÅ¥„Å´Ë™øÊï¥
      if (left + popoverWidth > viewportWidth - 20) {
        left = buttonRect.right - popoverWidth
      }
      
      // ‰∏ãÁ´Ø„Å´„ÅØ„ÅøÂá∫„ÇãÂ†¥Âêà„ÅØ‰∏äÂÅ¥„Å´Ë°®Á§∫
      if (top + popoverHeight > viewportHeight - 20) {
        top = buttonRect.top - popoverHeight - 8
      }
      
      // Â∑¶Á´Ø„Å´„ÅØ„ÅøÂá∫„ÇãÂ†¥Âêà„ÅØÊúÄÂ∞è„Éû„Éº„Ç∏„É≥„ÇíÁ¢∫‰øù
      if (left < 20) {
        left = 20
      }
      
      // ‰∏äÁ´Ø„Å´„ÅØ„ÅøÂá∫„ÇãÂ†¥Âêà„ÅØÊúÄÂ∞è„Éû„Éº„Ç∏„É≥„ÇíÁ¢∫‰øù
      if (top < 20) {
        top = 20
      }
      
      popoverStyle.value = {
        position: 'fixed',
        left: `${left}px`,
        top: `${top}px`,
        zIndex: 9999
      }
    }
  }

  // Â§ñÈÉ®„ÇØ„É™„ÉÉ„ÇØ„Åß„Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº„ÇíÈñâ„Åò„Çã
  const handleClickOutside = (event: Event) => {
    const target = event.target as HTMLElement
    if (showScoreDetails.value && !target.closest('[data-score-popover]') && !target.closest('button')) {
      showScoreDetails.value = false
    }
  }

  // ÂàùÊúü„ÉÅ„Çß„ÉÉ„ÇØ
  checkMobile()
  
  // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†
  window.addEventListener('resize', checkMobile)
  document.addEventListener('click', handleClickOutside)
  
  // „Çπ„Ç≥„Ç¢Ë©≥Á¥∞Ë°®Á§∫ÊôÇ„ÅÆ‰ΩçÁΩÆË™øÊï¥
  watch(showScoreDetails, () => {
    if (showScoreDetails.value) {
      nextTick(() => {
        updatePopoverPosition()
      })
    }
  })
  
  // „Çπ„ÇØ„É≠„Éº„É´„ÇÑ„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆ‰ΩçÁΩÆÊõ¥Êñ∞
  window.addEventListener('scroll', updatePopoverPosition)
  window.addEventListener('resize', updatePopoverPosition)
  
  onUnmounted(() => {
    window.removeEventListener('resize', checkMobile)
    document.removeEventListener('click', handleClickOutside)
    window.removeEventListener('scroll', updatePopoverPosition)
    window.removeEventListener('resize', updatePopoverPosition)
  })
})

// ÂàùÊúüÂåñÊôÇ„Å´„É¢„Éê„Ç§„É´Âà§ÂÆö„ÇíÂÆüË°å
if (typeof window !== 'undefined') {
  isMobile.value = window.innerWidth < 768
}
// ÂÜÜ„Ç∞„É©„ÉïÁî®„ÅÆË®àÁÆó
const circumference = 2 * Math.PI * 70 // r=70

function getStrokeDashoffset(score: number): number {
  const progress = Math.min(100, Math.max(0, score))
  return circumference - (progress / 100) * circumference
}

// SEOË®≠ÂÆö
useHead({
  title: computed(() => `${book.value?.title || 'Êõ∏Á±çË©≥Á¥∞'} - Tech Book Rank`),
  meta: [
    { 
      name: 'description', 
      content: computed(() => book.value ? 
        `${book.value.title}„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÄÇ${book.value.mentionCount}ÂõûË®ÄÂèä„Åï„Çå„Å¶„ÅÑ„Çã‰∫∫Ê∞ó„ÅÆÊäÄË°ìÊõ∏„Åß„Åô„ÄÇ` :
        'ÊäÄË°ìÊõ∏„ÅÆË©≥Á¥∞ÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ')
    }
  ]
})
</script>

<style scoped>
/* „ÅäÊ∞ó„Å´ÂÖ•„ÇäÁä∂ÊÖã„ÅÆ„Éè„Éº„Éà„Ç¢„Ç§„Ç≥„É≥„ÇíÁ¢∫ÂÆü„Å´Ëµ§Ëâ≤„ÅßÂ°ó„Çä„Å§„Å∂„Åó */
.heart-filled :deep(svg) {
  color: #ef4444 !important;
  fill: #ef4444 !important;
}

.heart-filled :deep(svg path) {
  fill: #ef4444 !important;
  stroke: #ef4444 !important;
}

.heart-empty :deep(svg) {
  color: #d1d5db !important;
  fill: #d1d5db !important;
}

.heart-empty :deep(svg path) {
  fill: #d1d5db !important;
  stroke: #d1d5db !important;
}

/* „Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™„Çª„É¨„ÇØ„Çø„Éº */
.favorite-heart-icon.text-red-500 :deep(svg) {
  color: #ef4444 !important;
  fill: #ef4444 !important;
}

.favorite-heart-icon.text-red-500 :deep(svg path) {
  fill: #ef4444 !important;
  stroke: #ef4444 !important;
}

.favorite-heart-icon.fill-red-500 :deep(svg) {
  fill: #ef4444 !important;
}

.favorite-heart-icon.fill-red-500 :deep(svg path) {
  fill: #ef4444 !important;
  stroke: #ef4444 !important;
}

.favorite-heart-icon.text-gray-300 :deep(svg) {
  color: #d1d5db !important;
  fill: #d1d5db !important;
}

.favorite-heart-icon.text-gray-300 :deep(svg path) {
  fill: #d1d5db !important;
  stroke: #d1d5db !important;
}

.favorite-heart-icon.fill-gray-300 :deep(svg) {
  fill: #d1d5db !important;
}

.favorite-heart-icon.fill-gray-300 :deep(svg path) {
  fill: #d1d5db !important;
  stroke: #d1d5db !important;
}
</style>

